<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exam</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #progressContainer {
      width: 100%;
      background-color: #eee;
      height: 20px;
      margin-bottom: 10px;
      margin-top: 10px;
      display: none;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
    }
  </style>
</head><body>
  <div class="container">

    <button onclick="location.href='index.html'">üîô Back to Homepage</button>

    <div class="settings-container">
      <h3>Select Topics and Levels:</h3>
      <div id="topicLevelContainer"></div>
      <button id="addTopicBtn">‚ûï Add Topic + Level</button>

      <h3>Select Translation Language:</h3>
      <select id="languageDropdown"><option value="">--Select--</option></select>

      <h3>Select Source Language:</h3>
      <select id="sourceLangDropdown"><option value="">--Select--</option></select>

      <button id="examBtn" disabled>Start Exam</button>
    </div>

    <button id="exitQuizBtn" style="display:none; margin-top:10px;">‚èπ Exit & Return to Settings</button>

    <div id="quiz" style="display:none; margin-top:20px;">
      <p id="wordDisplay" style="font-weight:bold;"></p>
      <p id="questionCounter" style="font-weight:bold; color:blue;"></p>
      <input type="text" id="userInput" placeholder="Write translation" />
      <button id="checkBtn">Check Answer</button>
      <button id="nextBtn" style="display:none;">Next</button>

      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>

      <p id="feedback"></p>
      <p id="correctAnswer"></p>
    </div>

  </div>
<script>
let jsonData = {};
let selectedCombos = [];
let currentLang = "";
let sourceLang = "";

let examWords = [];
let examIndex = 0;
let examScore = 0;
let examTotal = 0;
let isExamMode = false;
let currentWord = "";

const topicLevelContainer = document.getElementById("topicLevelContainer");
const addTopicBtn = document.getElementById("addTopicBtn");
const languageDropdown = document.getElementById("languageDropdown");
const sourceLangDropdown = document.getElementById("sourceLangDropdown");
const examBtn = document.getElementById("examBtn");
const exitQuizBtn = document.getElementById("exitQuizBtn");
const quiz = document.getElementById("quiz");
const settingsContainer = document.querySelector(".settings-container");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");

fetch("vocab-l.json")
  .then(res => res.json())
  .then(data => {
    jsonData = data;
    addTopicLevelSelector();
  });

function addTopicLevelSelector() {
  const wrapper = document.createElement("div");
  wrapper.className = "topic-level-row";
  wrapper.style.marginBottom = "10px";

  const topicSelect = document.createElement("select");
  topicSelect.innerHTML = '<option value="">--Select Topic--</option><option value="ALL">ALL</option>';
  for (const topic in jsonData) {
    const opt = document.createElement("option");
    opt.value = topic;
    opt.textContent = topic;
    topicSelect.appendChild(opt);
  }

  const levelSelect = document.createElement("select");
  levelSelect.innerHTML = `
    <option value="">--Select Level--</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="A+B">A+B</option>
    <option value="A+C">A+C</option>
    <option value="B+C">B+C</option>
    <option value="ALL">ALL</option>
  `;
  levelSelect.disabled = true;

  topicSelect.addEventListener("change", () => {
    levelSelect.disabled = !topicSelect.value;
    enforceComboLogic();
    updateLangOptions();
  });

  levelSelect.addEventListener("change", () => {
    enforceComboLogic();
    updateLangOptions();
  });

  const removeBtn = document.createElement("button");
  removeBtn.textContent = "‚ùå";
  removeBtn.style.marginLeft = "10px";
  removeBtn.addEventListener("click", () => {
    wrapper.remove();
    enforceComboLogic();
    updateLangOptions();
  });

  wrapper.appendChild(topicSelect);
  wrapper.appendChild(levelSelect);
  wrapper.appendChild(removeBtn);
  topicLevelContainer.appendChild(wrapper);
}

addTopicBtn.addEventListener("click", () => addTopicLevelSelector());


// ======================
// ‚úÖ ŸÖŸÜÿ∑ŸÇ ÿ∞ŸÉŸä ÿ¨ÿØŸäÿØ ŸáŸÜÿß
// ======================
function enforceComboLogic() {
  const rows = Array.from(document.querySelectorAll(".topic-level-row"));

  const combos = [];
  for (const row of rows) {
    const topic = row.children[0].value;
    const level = row.children[1].value;
    if (topic && level) combos.push({ topic, level, row });
  }

  function levelToSet(level) {
    if (!level) return new Set();
    if (level === "ALL") return new Set(["A","B","C"]);
    return new Set(level.split("+"));
  }

  const rowsToRemove = new Set();

  // üîπ ÿ£ŸàŸÑÿßŸã: ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ALL+ALL ŸÜÿ≠ÿ∞ŸÅ ŸÉŸÑ ŸÖÿß ŸÇÿ®ŸÑŸá
  const hasAllAll = combos.some(c => c.topic === "ALL" && c.level === "ALL");
  if (hasAllAll) {
    combos.forEach(c => {
      if (!(c.topic === "ALL" && c.level === "ALL")) rowsToRemove.add(c.row);
    });
  }

  // üîπ ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇŸäÿ© ÿ®ŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
  for (let i = 0; i < combos.length; i++) {
    for (let j = i + 1; j < combos.length; j++) {
      const A = combos[i];
      const B = combos[j];
      if (rowsToRemove.has(A.row) || rowsToRemove.has(B.row)) continue;

      const sameOrAllTopic = (A.topic === B.topic) || A.topic === "ALL" || B.topic === "ALL";
      if (!sameOrAllTopic) continue;

      const setA = levelToSet(A.level);
      const setB = levelToSet(B.level);

      const AcoversB = [...setB].every(x => setA.has(x));
      const BcoversA = [...setA].every(x => setB.has(x));

      // üîπ ÿ•ÿ∞ÿß ŸÉÿßŸÜ A ÿ£ÿ¥ŸÖŸÑ ŸÖŸÜ B ‚Üí ŸÜÿ≠ÿ∞ŸÅ B
      if (AcoversB && (A.topic === B.topic || A.topic === "ALL")) {
        rowsToRemove.add(B.row);
      }
      // üîπ ÿ•ÿ∞ÿß ŸÉÿßŸÜ B ÿ£ÿ¥ŸÖŸÑ ŸÖŸÜ A ‚Üí ŸÜÿ≠ÿ∞ŸÅ A
      else if (BcoversA && (A.topic === B.topic || B.topic === "ALL")) {
        rowsToRemove.add(A.row);
      }
    }
  }

  // üîπ ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸÅŸàŸÅ ÿßŸÑÿ£ÿ∂ÿπŸÅ
  rowsToRemove.forEach(r => {
    if (r.parentElement) r.parentElement.removeChild(r);
  });

  // ÿ™ÿ≠ÿØŸäÿ´ selectedCombos
  selectedCombos = [];
  document.querySelectorAll(".topic-level-row").forEach(row => {
    const topic = row.children[0].value;
    const level = row.children[1].value;
    if (topic && level) selectedCombos.push({ topic, level });
  });

  // üîπ ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ALL+ALL
  addTopicBtn.disabled = hasAllAll;
  checkEnableButtons();
}
// ======================



function updateLangOptions() {
  if (selectedCombos.length === 0) {
    examBtn.disabled = true;
    return;
  }

  let firstEntry;
  for (const combo of selectedCombos) {
    const { topic, level } = combo;
    let chosenLevel = level.includes("+") ? level.split("+")[0] : level;
    const entries = topic === "ALL"
      ? Object.values(jsonData[Object.keys(jsonData)[0]][chosenLevel])
      : Object.values(jsonData[topic][chosenLevel]);
    if (entries && entries.length > 0) {
      firstEntry = entries[0];
      break;
    }
  }

  if (!firstEntry) return;
  const langs = Object.keys(firstEntry).concat("english");

  languageDropdown.innerHTML = '<option value="">--Select--</option>';
  sourceLangDropdown.innerHTML = '<option value="">--Select--</option>';
  langs.forEach(lang => {
    const opt1 = document.createElement("option");
    opt1.value = lang;
    opt1.textContent = lang;
    languageDropdown.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = lang;
    opt2.textContent = lang;
    sourceLangDropdown.appendChild(opt2);
  });
}

languageDropdown.addEventListener("change", () => {
  currentLang = languageDropdown.value;
  checkEnableButtons();
});

sourceLangDropdown.addEventListener("change", () => {
  sourceLang = sourceLangDropdown.value;
  checkEnableButtons();
});

function checkEnableButtons() {
  examBtn.disabled = !(selectedCombos.length && currentLang && sourceLang);
}

examBtn.addEventListener("click", () => {
  if (!selectedCombos.length || !currentLang || !sourceLang) return;
  startExam();
});

exitQuizBtn.addEventListener("click", () => {
  quiz.style.display = "none";
  exitQuizBtn.style.display = "none";
  settingsContainer.style.display = "block";
  resetExam();
});

function startExam() {
  settingsContainer.style.display = "none";
  quiz.style.display = "block";
  exitQuizBtn.style.display = "inline-block";

  examWords = [];

  selectedCombos.forEach(({ topic, level }) => {
    let levelsToInclude = [];
    if (level === "ALL") levelsToInclude = ["A","B","C"];
    else levelsToInclude = level.split("+");

    levelsToInclude.forEach(lvl => {
      if (topic === "ALL") {
        for (const t in jsonData) {
          if (jsonData[t][lvl]) {
            examWords.push(...Object.entries(jsonData[t][lvl]));
          }
        }
      } else {
        if (jsonData[topic][lvl]) {
          examWords.push(...Object.entries(jsonData[topic][lvl]));
        }
      }
    });
  });

  shuffleArray(examWords);

  const wordCount = examWords.length;
  if (wordCount >= 50) examTotal = 50;
  else if (wordCount >= 21) examTotal = 20;
  else if (wordCount >= 11) examTotal = 10;
  else examTotal = wordCount;

  examWords = examWords.slice(0, examTotal);
  examIndex = 0;
  examScore = 0;
  isExamMode = true;

  showExamWord();
  progressContainer.style.display = "block";
}

function showExamWord() {
  const [wordKey, wordData] = examWords[examIndex];
  currentWord = wordKey;
  const wordShown = sourceLang === "english" ? wordKey : wordData[sourceLang];
  document.getElementById("wordDisplay").textContent = `Word (${sourceLang}): ${wordShown}`;
  document.getElementById("questionCounter").textContent = `Question ${examIndex + 1} / ${examTotal}`;
  document.getElementById("userInput").value = "";
  document.getElementById("feedback").textContent = "";
  document.getElementById("correctAnswer").textContent = "";
  document.getElementById("nextBtn").style.display = "none";
  updateProgressBar();
}

function updateProgressBar() {
  const progress = ((examIndex) / examTotal) * 100;
  progressBar.style.width = progress + "%";
}

const checkBtn = document.getElementById("checkBtn");
const nextBtn = document.getElementById("nextBtn");

checkBtn.addEventListener("click", () => {
  const input = document.getElementById("userInput").value.trim().toLowerCase();
  const wordData = examWords[examIndex][1];
  let correct = currentLang === "english" ? examWords[examIndex][0].toLowerCase() : wordData[currentLang]?.toLowerCase();

  if (input === correct) {
    document.getElementById("feedback").textContent = "‚úÖ Correct!";
    document.getElementById("feedback").style.color = "green";
    if (isExamMode) examScore++;
  } else {
    document.getElementById("feedback").textContent = "‚ùå Wrong!";
    document.getElementById("feedback").style.color = "red";
  }

  document.getElementById("correctAnswer").textContent = `Correct answer: ${correct}`;
  document.getElementById("nextBtn").style.display = "inline";
});

nextBtn.addEventListener("click", () => {
  examIndex++;
  if (examIndex < examTotal) {
    showExamWord();
  } else {
    isExamMode = false;
    showExamResult();
  }
});

function showExamResult() {
  const errors = examTotal - examScore;
  const percent = ((examScore / examTotal) * 100).toFixed(2);
  let remark = "";

  if (errors <= 3) remark = "‚ú® Excellent!";
  else if (errors <= examTotal * 0.25) remark = "üëç Very Good";
  else if (errors <= examTotal * 0.5) remark = "üôÇ Good";
  else remark = "üí° You need to work more";

  quiz.innerHTML = `
    <h3>Your Exam Grade:</h3>
    <p>Score: ${examScore} / ${examTotal}</p>
    <p>Percentage: ${percent}%</p>
    <p>${remark}</p>
    <button onclick="location.reload()">üîÑ Try Again</button>
  `;
  exitQuizBtn.style.display = "none";
}

function resetExam() {
  examWords = [];
  examIndex = 0;
  examScore = 0;
  examTotal = 0;
  isExamMode = false;
  progressBar.style.width = "0%";
  progressContainer.style.display = "none";
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
</script>

</body>









</html>
